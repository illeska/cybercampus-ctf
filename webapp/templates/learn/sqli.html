{% extends "base.html" %}
{% block title %}Cours : Injection SQL - CyberCampus CTF{% endblock %}

{% block content %}
<section class="page-wrapper course-page">
  
  <!-- Breadcrumb -->
  <div class="breadcrumb">
    <a href="{{ url_for('learn') }}">ğŸ“š BibliothÃ¨que</a>
    <span class="separator">/</span>
    <span class="current">Injection SQL</span>
  </div>

  <!-- En-tÃªte du cours -->
  <div class="course-header">
    <div class="course-header-icon">ğŸ’‰</div>
    <div class="course-header-content">
      <h1>Injection SQL (SQLi)</h1>
      <p class="course-subtitle">Comprendre et prÃ©venir les attaques sur les bases de donnÃ©es</p>
      <div class="course-badges">
        <span class="badge-critical">Critique</span>
        <span class="badge-time">ğŸ“– 15 min</span>
        <span class="badge-level">âš¡ DÃ©butant</span>
      </div>
    </div>
  </div>

  <!-- Contenu du cours -->
  <div class="course-content">

    <!-- Section 1 -->
    <div class="course-section">
      <h2>ğŸ” Qu'est-ce qu'une injection SQL ?</h2>
      <p>
        L'injection SQL est une technique d'attaque qui permet Ã  un utilisateur malveillant d'<strong>injecter du code SQL</strong> 
        dans une requÃªte de base de donnÃ©es. Cette vulnÃ©rabilitÃ© survient lorsque les donnÃ©es fournies par l'utilisateur 
        sont directement intÃ©grÃ©es dans une requÃªte SQL sans validation ni Ã©chappement appropriÃ©.
      </p>
      <p>
        Les consÃ©quences peuvent Ãªtre catastrophiques : contournement de l'authentification, vol de donnÃ©es sensibles, 
        modification ou suppression de donnÃ©es, et mÃªme prise de contrÃ´le totale du serveur dans certains cas.
      </p>
      
      <div class="info-box">
        <div class="info-icon">ğŸ’¡</div>
        <div class="info-content">
          <strong>Le saviez-vous ?</strong>
          <p>L'injection SQL figure dans le Top 3 du classement OWASP depuis plus de 15 ans. 
          MalgrÃ© sa dangerositÃ© connue, elle reste l'une des vulnÃ©rabilitÃ©s les plus exploitÃ©es sur le web.</p>
        </div>
      </div>
    </div>

    <!-- Section 2 -->
    <div class="course-section">
      <h2>âš™ï¸ Comment fonctionne une attaque SQLi ?</h2>
      <p>Prenons un exemple concret d'un formulaire de connexion vulnÃ©rable :</p>
      
      <div class="code-block vulnerable">
        <div class="code-header">
          <span class="code-status">âŒ Code vulnÃ©rable</span>
          <span class="code-lang">Python / Flask</span>
        </div>
        <pre><code>username = request.form['username']
password = request.form['password']

# Danger : ConcatÃ©nation directe dans la requÃªte SQL
query = f"SELECT * FROM users WHERE username='{username}' AND password='{password}'"
cursor.execute(query)

user = cursor.fetchone()
if user:
    login_user(user)</code></pre>
      </div>

      <p>Ce code semble fonctionnel, mais il est <strong>extrÃªmement dangereux</strong>. Voici pourquoi :</p>

      <h3>ScÃ©nario d'attaque :</h3>
      <p>Un attaquant entre les valeurs suivantes dans le formulaire :</p>
      
      <div class="attack-showcase">
        <div class="attack-input">
          <label>Username :</label>
          <code>admin' OR '1'='1' --</code>
        </div>
        <div class="attack-input">
          <label>Password :</label>
          <code><em>(n'importe quoi)</em></code>
        </div>
      </div>

      <p>La requÃªte SQL devient alors :</p>
      
      <div class="code-block">
        <pre><code>SELECT * FROM users WHERE username='admin' OR '1'='1' --' AND password='...'</code></pre>
      </div>

      <div class="explanation-box">
        <h4>Analyse de l'attaque :</h4>
        <ul>
          <li><code>'admin'</code> : Tentative de connexion en tant qu'admin</li>
          <li><code>OR '1'='1'</code> : Condition toujours vraie qui court-circuite la vÃ©rification</li>
          <li><code>--</code> : Commentaire SQL qui ignore tout ce qui suit (le mot de passe)</li>
        </ul>
        <p><strong>RÃ©sultat :</strong> L'attaquant se connecte en tant qu'admin sans connaÃ®tre le mot de passe !</p>
      </div>

      <h3>Autres types d'attaques :</h3>
      <div class="attack-types">
        <div class="attack-type-card">
          <h4>ğŸ”“ Bypass d'authentification</h4>
          <p>Se connecter sans identifiants valides</p>
          <code>admin' --</code>
        </div>
        <div class="attack-type-card">
          <h4>ğŸ“‚ Extraction de donnÃ©es</h4>
          <p>RÃ©cupÃ©rer des informations sensibles</p>
          <code>' UNION SELECT password FROM users --</code>
        </div>
        <div class="attack-type-card">
          <h4>ğŸ’£ Modification de donnÃ©es</h4>
          <p>AltÃ©rer ou supprimer des enregistrements</p>
          <code>'; DROP TABLE users; --</code>
        </div>
      </div>
    </div>

    <!-- Section 3 -->
    <div class="course-section">
      <h2>ğŸ›¡ï¸ Comment se protÃ©ger ?</h2>
      <p>Heureusement, il existe plusieurs mÃ©thodes efficaces pour prÃ©venir les injections SQL :</p>

      <div class="protection-method">
        <div class="method-number">1</div>
        <div class="method-content">
          <h3>RequÃªtes prÃ©parÃ©es (Prepared Statements)</h3>
          <p>La mÃ©thode la plus sÃ»re : sÃ©parez complÃ¨tement la structure SQL des donnÃ©es utilisateur.</p>
          
          <div class="code-block safe">
            <div class="code-header">
              <span class="code-status">âœ… Code sÃ©curisÃ©</span>
              <span class="code-lang">Python / SQLite</span>
            </div>
            <pre><code>username = request.form['username']
password = request.form['password']

# Les ? sont des placeholders - les donnÃ©es sont Ã©chappÃ©es automatiquement
query = "SELECT * FROM users WHERE username=? AND password=?"
cursor.execute(query, (username, password))

user = cursor.fetchone()</code></pre>
          </div>

          <div class="success-box">
            <strong>Pourquoi c'est sÃ»r :</strong> Les paramÃ¨tres sont traitÃ©s comme des donnÃ©es pures, 
            jamais comme du code SQL. Impossible d'injecter des commandes.
          </div>
        </div>
      </div>

      <div class="protection-method">
        <div class="method-number">2</div>
        <div class="method-content">
          <h3>ORM (Object-Relational Mapping)</h3>
          <p>Utilisez un framework qui abstrait les requÃªtes SQL et gÃ¨re la sÃ©curitÃ© automatiquement.</p>
          
          <div class="code-block safe">
            <div class="code-header">
              <span class="code-status">âœ… Code sÃ©curisÃ©</span>
              <span class="code-lang">Python / SQLAlchemy</span>
            </div>
            <pre><code>from models import User

username = request.form['username']
password = request.form['password']

# SQLAlchemy Ã©chappe automatiquement les valeurs
user = User.query.filter_by(
    username=username,
    password=password
).first()

if user:
    login_user(user)</code></pre>
          </div>
        </div>
      </div>

      <div class="protection-method">
        <div class="method-number">3</div>
        <div class="method-content">
          <h3>Validation et filtrage des entrÃ©es</h3>
          <p>VÃ©rifiez toujours les donnÃ©es utilisateur avant de les utiliser :</p>
          <ul>
            <li>DÃ©finissez des types de donnÃ©es attendus (int, email, etc.)</li>
            <li>Limitez la longueur des champs</li>
            <li>Utilisez des expressions rÃ©guliÃ¨res pour valider le format</li>
            <li>CrÃ©ez une liste blanche de caractÃ¨res autorisÃ©s</li>
          </ul>
        </div>
      </div>

      <div class="protection-method">
        <div class="method-number">4</div>
        <div class="method-content">
          <h3>Principe du moindre privilÃ¨ge</h3>
          <p>Limitez les permissions du compte de base de donnÃ©es utilisÃ© par votre application :</p>
          <ul>
            <li>N'utilisez jamais un compte <code>root</code> ou <code>admin</code></li>
            <li>Accordez uniquement les permissions nÃ©cessaires (SELECT, INSERT, UPDATE)</li>
            <li>Interdisez DROP, CREATE, ALTER sur les comptes applicatifs</li>
            <li>SÃ©parez les comptes par environnement (dev, prod)</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Section 4 -->
    <div class="course-section">
      <h2>ğŸ“ RÃ©sumÃ© des bonnes pratiques</h2>
      <div class="checklist">
        <div class="checklist-item">
          <span class="check">âœ…</span>
          <span>Utilisez toujours des requÃªtes prÃ©parÃ©es ou un ORM</span>
        </div>
        <div class="checklist-item">
          <span class="check">âœ…</span>
          <span>Ne concatÃ©nez JAMAIS directement les entrÃ©es utilisateur dans du SQL</span>
        </div>
        <div class="checklist-item">
          <span class="check">âœ…</span>
          <span>Validez et filtrez toutes les donnÃ©es cÃ´tÃ© serveur</span>
        </div>
        <div class="checklist-item">
          <span class="check">âœ…</span>
          <span>Limitez les privilÃ¨ges de vos comptes de base de donnÃ©es</span>
        </div>
        <div class="checklist-item">
          <span class="check">âœ…</span>
          <span>Loggez et surveillez les tentatives d'injection</span>
        </div>
        <div class="checklist-item">
          <span class="check">âœ…</span>
          <span>Gardez vos frameworks et bibliothÃ¨ques Ã  jour</span>
        </div>
      </div>
    </div>

    <!-- CTA Challenge -->
    <div class="challenge-cta">
      <div class="cta-content">
        <h2>ğŸ¯ PrÃªt Ã  pratiquer ?</h2>
        <p>
          Maintenant que vous comprenez les injections SQL, testez vos connaissances sur notre challenge interactif ! 
          Vous devrez exploiter une vulnÃ©rabilitÃ© SQLi pour vous connecter en tant qu'administrateur.
        </p>
        <div class="cta-info">
          <div class="cta-detail">
            <span class="cta-icon">â­</span>
            <span><strong>150 points</strong></span>
          </div>
          <div class="cta-detail">
            <span class="cta-icon">ğŸ“</span>
            <span>Niveau dÃ©butant</span>
          </div>
          <div class="cta-detail">
            <span class="cta-icon">â±ï¸</span>
            <span>15-30 minutes</span>
          </div>
        </div>
        <a href="{{ url_for('challenge_view', challenge_id=1) }}" class="btn challenge-btn-large">
          AccÃ©der au challenge SQL Injection
        </a>
      </div>
    </div>

    <!-- Navigation -->
    <div class="course-navigation">
      <a href="{{ url_for('learn') }}" class="nav-btn back">
        â† Retour Ã  la bibliothÃ¨que
      </a>
      <a href="{{ url_for('learn_xss') }}" class="nav-btn next">
        Cours suivant : XSS â†’
      </a>
    </div>

  </div>

</section>
{% endblock %}