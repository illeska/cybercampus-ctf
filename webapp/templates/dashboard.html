{% extends "base.html" %}
{% block title %}Tableau de Bord - CyberCampus CTF{% endblock %}

{% block content %}
<section class="page-wrapper">
  
  <h2 class="animated-title">Bienvenue {{ user.pseudo }} ğŸ‘‹</h2>
  <p>Voici un aperÃ§u de votre progression dans le CyberCampus.</p>

  <div class="stats">
    <div class="card stat-card">
      <div class="stat-icon" style="font-size: 2.5rem; margin-bottom: 10px;">ğŸ’</div>
      <h3>{{ user.score }}</h3>
      <p style="color: #94a3b8; font-weight: 500;">Points Totaux</p>
    </div>
    
    <div class="card stat-card">
      <div class="stat-icon" style="font-size: 2.5rem; margin-bottom: 10px;">ğŸ†</div>
      <h3>{{ user.get_solved_challenges()|length }}</h3>
      <p style="color: #94a3b8; font-weight: 500;">Challenges ValidÃ©s</p>
    </div>
    
    <div class="card stat-card">
      <div class="stat-icon" style="font-size: 2.5rem; margin-bottom: 10px;">ğŸ“…</div>
      <h3 style="font-size: 1.5rem;">{{ user.created_at.strftime('%d/%m/%Y') }}</h3>
      <p style="color: #94a3b8; font-weight: 500;">
        Inscrit depuis {{ (now() - user.created_at).days }} jours
      </p>
    </div>
  </div>

  <div class="section-large" style="margin-top: 40px; text-align: left;">
    <h3 style="margin-bottom: 20px;">ğŸ“Š Progression Globale</h3>
    
    {% set total_challenges = Challenge.query.filter_by(actif=True).count() %}
    {% set solved_count = user.get_solved_challenges()|length %}
    {% set progress_percent = (solved_count / total_challenges * 100) if total_challenges > 0 else 0 %}
    
    <div class="progress-container" style="background: rgba(255,255,255,0.05); border-radius: 50px; padding: 4px; border: 1px solid rgba(255,255,255,0.1);">
      <div class="progress-fill" style="width: {{ progress_percent }}%; background: linear-gradient(90deg, #00f5c0, #0088ff); height: 12px; border-radius: 50px; box-shadow: 0 0 10px rgba(0, 245, 192, 0.5); transition: width 1s ease;"></div>
    </div>
    
    <div style="display: flex; justify-content: space-between; margin-top: 10px; color: #cbd5e1; font-size: 0.9rem;">
      <span><strong>{{ solved_count }}</strong> / {{ total_challenges }} challenges complÃ©tÃ©s</span>
      <span style="color: #00f5c0; font-weight: bold;">{{ "%.0f"|format(progress_percent) }}%</span>
    </div>
  </div>

  {% set in_progress = user.get_in_progress_challenges() %}
  {% if in_progress %}
  <div style="width: 100%; margin-top: 50px;">
    <h2 class="animated-title" style="font-size: 1.8rem; text-align: left; margin-bottom: 20px;">âš¡ Reprendre les challenges</h2>
    
    <div class="challenges-grid">
      {% for challenge in in_progress %}
        <div class="challenge-card">
          <div class="challenge-header">
            <h3>{{ challenge.titre }}</h3>
            <span class="challenge-points" style="color: #f59e0b; background: rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.3);">
              En cours
            </span>
          </div>
          <p class="challenge-description" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
            {{ challenge.description }}
          </p>
          <a href="{{ url_for('challenge_view', challenge_id=challenge.id) }}" class="btn challenge-btn">
            Continuer â†’
          </a>
        </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  {% set recent_submissions = user.submissions.order_by(Submission.timestamp.desc()).limit(5).all() %}
  {% if recent_submissions %}
  <div class="section-large" style="margin-top: 50px; padding: 0; overflow: hidden; border: 1px solid rgba(255,255,255,0.05);">
    <div style="padding: 20px; background: rgba(255,255,255,0.02); border-bottom: 1px solid rgba(255,255,255,0.05);">
      <h3 style="margin: 0; font-size: 1.2rem;">ğŸ“ Historique RÃ©cent</h3>
    </div>
    
    <div class="history-list">
      {% for sub in recent_submissions %}
        <div class="history-item" style="display: flex; align-items: center; justify-content: space-between; padding: 15px 25px; border-bottom: 1px solid rgba(255,255,255,0.03);">
          
          <div style="display: flex; align-items: center; gap: 15px;">
            <div style="
              width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;
              background: {{ 'rgba(16, 185, 129, 0.2)' if sub.correct else 'rgba(239, 68, 68, 0.2)' }};
              color: {{ '#10b981' if sub.correct else '#ef4444' }};
            ">
              {{ 'âœ“' if sub.correct else 'âœ—' }}
            </div>
            
            <div style="text-align: left;">
              <div style="color: #fff; font-weight: 600;">{{ sub.challenge.titre }}</div>
              <div style="color: #64748b; font-size: 0.8rem;">{{ sub.timestamp.strftime('%d/%m/%Y Ã  %H:%M') }}</div>
            </div>
          </div>

          <div style="font-weight: 600; color: {{ '#10b981' if sub.correct else '#ef4444' }};">
            {{ ('+' ~ sub.challenge.points ~ ' pts') if sub.correct else 'Ã‰chouÃ©' }}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <div style="margin-top: 50px; text-align: center;">
    <a href="{{ url_for('challenges_list') }}" class="btn primary-btn" style="width: auto; display: inline-flex; padding: 12px 30px;">
      ğŸ¯ Voir tous les challenges
    </a>
  </div>

</section>
{% endblock %}